generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("RUNESSE_DATABASE_URL")
}

model AuditLog {
  id            String       @id
  actorId       String?
  action        String
  target        String?
  meta          Json?
  createdAt     DateTime     @default(now())
  transactionId String?
  User          User?        @relation(fields: [actorId], references: [id])
  Transaction   Transaction? @relation(fields: [transactionId], references: [id])

  @@index([actorId, createdAt])
}

model BuyerRequest {
  id            String        @id @default(cuid())
  buyerId       String
  productUrl    String
  paymentLink   String
  checkoutPrice Decimal       @db.Decimal(12, 2)
  statedBenefit Decimal       @db.Decimal(12, 2)
  otherCharges  Decimal       @default(0) @db.Decimal(12, 2)
  status        RequestStatus @default(PENDING_ADMIN_APPROVAL)
  createdAt     DateTime      @default(now())

  User          User          @relation(fields: [buyerId], references: [id])
  ProofUpload   ProofUpload[]
  Transaction   Transaction?

  @@index([buyerId, status])
}

model CardholderOffer {
  id           String   @id
  cardholderId String
  binPrefix    String?
  issuer       String?
  network      String?
  notes        String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())

  User         User     @relation(fields: [cardholderId], references: [id])

  @@index([cardholderId, active])
}

model ProofUpload {
  id             String        @id
  uploaderId     String
  buyerRequestId String?
  transactionId  String?
  kind           String
  s3Key          String
  mimeType       String?
  sizeBytes      Int?
  scanStatus     ScanStatus    @default(PENDING)
  createdAt      DateTime      @default(now())

  BuyerRequest   BuyerRequest? @relation(fields: [buyerRequestId], references: [id])
  Transaction    Transaction?  @relation(fields: [transactionId], references: [id])
  User           User          @relation(fields: [uploaderId], references: [id])

  @@index([buyerRequestId])
  @@index([transactionId])
}

model Transaction {
  id             String        @id
  buyerRequestId String        @unique
  mode           String        @default("manual")
  amountPayable  Decimal       @db.Decimal(12, 2)
  status         TxStatus      @default(AWAITING_CARDHOLDER_PAYMENT)
  paymentRef     String?
  escrowStatus   String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  AuditLog       AuditLog[]
  ProofUpload    ProofUpload[]
  BuyerRequest   BuyerRequest  @relation(fields: [buyerRequestId], references: [id])

  @@index([status])
}

// ---------- LEDGER MODEL ----------

model LedgerEntry {
  id          String        @id @default(cuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  scope       LedgerScope
  eventType   LedgerEventType
  side        LedgerSide?
  amount      Decimal?      @db.Decimal(18, 2)
  currency    String?       @default("INR")
  accountKey  String?
  referenceId String?
  referenceType String?
  buyerId      String?
  cardholderId String?
  adminId      String?
  description String?
  meta        Json?

  @@index([scope, createdAt])
  @@index([referenceType, referenceId])
  @@index([buyerId])
  @@index([cardholderId])
  @@index([accountKey, createdAt])
  @@index([adminId])
}

enum RequestStatus {
  PENDING_ADMIN_APPROVAL
  APPROVED
  REJECTED
  AWAITING_CARDHOLDER_PAYMENT
  FULFILLED
  CANCELLED
}

enum ScanStatus {
  PENDING
  CLEAN
  INFECTED
  ERROR
}

enum TxStatus {
  AWAITING_CARDHOLDER_PAYMENT
  AWAITING_ADMIN_VERIFICATION
  SETTLED
  CANCELLED
}

// ---------- LEDGER ENUMS ----------

enum LedgerScope {
  PLATFORM
  USER_TRANSACTION
  WALLET
  ESCROW
}

enum LedgerSide {
  DEBIT
  CREDIT
}

enum BankAccountStatus {
  PENDING
  VERIFIED
  FAILED
}

enum LedgerEventType {
  REQUEST_CREATED
  REQUEST_UPDATED
  REQUEST_CANCELLED
  STATUS_CHANGED
  SYSTEM_AUTO_EXPIRED
  CARD_SELECTED_FOR_PAYMENT
  CARDHOLDER_ACCEPTED
  CARDHOLDER_REJECTED
  BUYER_PROOF_UPLOADED
  CARDHOLDER_PROOF_UPLOADED
  ADMIN_VERIFICATION_PASSED
  ADMIN_VERIFICATION_FAILED
  ADMIN_VIEWED_REQUEST
  ADMIN_APPROVED_REQUEST
  ADMIN_REJECTED_REQUEST
  ADMIN_MARKED_COMPLETED
  MANUAL_REIMBURSEMENT_INITIATED
  MANUAL_REIMBURSEMENT_COMPLETED
  ESCROW_FUNDS_HELD
  ESCROW_FUNDS_RELEASED
  ESCROW_REFUND_INITIATED
  ESCROW_REFUND_COMPLETED
  BUYER_DEPOSIT_CREATED
  BUYER_DEPOSIT_CONFIRMED
  CARDHOLDER_REIMBURSEMENT_INITIATED
  CARDHOLDER_REIMBURSEMENT_COMPLETED
  RUNESSE_COMMISSION_ACCRUED
  RUNESSE_COMMISSION_SETTLED
  ADJUSTMENT
  NOTE
}

enum UserRole {
  BUYER
  CARDHOLDER
  BOTH
}

enum PanStatus {
  PENDING
  VERIFIED
  FAILED
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  name              String?
  role              UserRole  @default(BUYER)
  buyerEnabled      Boolean   @default(false)
  cardholderEnabled Boolean   @default(false)
  trustedDeviceHash String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  panMasked     String?
  panStatus     PanStatus @default(PENDING)
  panVerifiedAt DateTime?
  panName       String?

  AuditLog        AuditLog[]
  BuyerRequest    BuyerRequest[]
  CardholderOffer CardholderOffer[]
  ProofUpload     ProofUpload[]

  profile UserProfile?
}

model UserProfile {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  fullName    String
  phoneNumber String
  role        UserRole
  buyerEnabled      Boolean   @default(false)
  cardholderEnabled Boolean   @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserBankAccount {
  id                 String            @id @default(uuid())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  userEmail          String
  role               UserRole
  buyerEnabled      Boolean   @default(false)
  cardholderEnabled Boolean   @default(false)
  accountHolderName  String
  accountNumber      String
  ifsc               String
  bankName           String?
  branchName         String?
  status             BankAccountStatus @default(PENDING)
  verificationMethod String?
  lastVerifiedAt     DateTime?

  @@index([userEmail, role])
}

// ---------- SAVED CARD ----------

model SavedCard {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  cardholderEmail String
  bin             String
  last4           String
  issuer          String?
  brand           String?
  network         String?
  country         String?
  label           String?
  isActive        Boolean   @default(true)

  requests        Request[] @relation("SavedCardRequests")

  @@index([cardholderEmail])
  @@index([cardholderEmail, bin, last4])
}

// ---------- REQUEST (PHASE-1 MAIN FLOW) ----------

model Request {
  id                         String           @id @default(cuid())
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt

  buyerCheckoutScreenshotUrl String?          @db.Text
  buyerProductScreenshotUrl  String?          @db.Text
  cardholderInvoiceUrl       String?          @db.Text
  cardholderCardProofUrl     String?          @db.Text

  deliveryAddressText String? @db.Text
  deliveryMobile      String?

  matchedCardId              String?
  matchedCard                SavedCard?       @relation("SavedCardRequests", fields: [matchedCardId], references: [id])

  requestedIssuer            String?
  requestedNetwork           String?
  requestedCardLabel         String?

  buyerEmail                 String
  productLink                String
  productName                String?
  checkoutPrice              Int?
  notes                      String?

  status                     NewRequestStatus @default(SUBMITTED)

  matchedCardholderEmail     String?
  matchedAt                  DateTime?

  offerPercent               Float? @default(0)
  futureBenefitPercent       Float? @default(0)

  @@index([status, buyerEmail])
  @@index([matchedCardId])
}

enum NewRequestStatus {
  SUBMITTED
  ADMIN_APPROVED
  MATCHED
  COMPLETED
  REJECTED
  CANCELLED
}

// ---------- ADMIN DEVICE TRUST ----------

model AdminDevice {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  adminEmail String
  deviceId   String
  label      String?
  lastSeenAt DateTime @default(now())
  isRevoked  Boolean  @default(false)

  @@index([adminEmail, deviceId])
}